name: ğŸ” PR Quality Check

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===============================================
  # VÃ©rifications rapides pour PR
  # ===============================================
  pr-check:
    name: ğŸ“‹ PR Quality Gate
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        # NÃ©cessaire pour comparer avec main
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: ğŸ“Š Get changed files
      id: changed-files
      run: |
        echo "python_files=$(git diff --name-only origin/main...HEAD | grep '\.py$' | tr '\n' ' ')" >> $GITHUB_OUTPUT
    
    - name: ğŸ§¹ Check formatting on changed files
      if: steps.changed-files.outputs.python_files
      run: |
        if [ -n "${{ steps.changed-files.outputs.python_files }}" ]; then
          echo "Checking files: ${{ steps.changed-files.outputs.python_files }}"
          black --check ${{ steps.changed-files.outputs.python_files }}
        fi
    
    - name: ğŸ” Lint changed files
      if: steps.changed-files.outputs.python_files
      run: |
        if [ -n "${{ steps.changed-files.outputs.python_files }}" ]; then
          ruff check ${{ steps.changed-files.outputs.python_files }}
        fi
    
    - name: ğŸ’€ Check for new dead code
      if: steps.changed-files.outputs.python_files
      run: |
        if [ -n "${{ steps.changed-files.outputs.python_files }}" ]; then
          vulture ${{ steps.changed-files.outputs.python_files }} --min-confidence 95 || true
        fi
    
    - name: ğŸ“ PR Comment with results
      uses: actions/github-script@v6
      if: failure()
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âŒ **Quality checks failed!**\n\n' +
                  'ğŸ§¹ Run `black backend/` to fix formatting\n' +
                  'ğŸ” Run `ruff check --fix backend/` to fix linting\n' +
                  'ğŸ’€ Check `vulture backend/` for dead code\n\n' +
                  'âœ¨ Or run `make quality` to fix everything!'
          })

  # ===============================================
  # VÃ©rification de sÃ©curitÃ© sur changements
  # ===============================================
  security-diff:
    name: ğŸ”’ Security Diff
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install security tools
      run: |
        pip install bandit safety
    
    - name: ğŸ”’ Security scan on new code
      run: |
        # Scan seulement les fichiers modifiÃ©s
        git diff --name-only origin/main...HEAD | grep '\.py$' | xargs bandit -f json || true
    
    - name: ğŸ” Check new dependencies
      run: |
        # VÃ©rifier si requirements a changÃ©
        if git diff --name-only origin/main...HEAD | grep -E "(requirements|pyproject\.toml)"; then
          echo "ğŸ“¦ Dependencies changed, running safety check..."
          safety check || true
        else
          echo "ğŸ“¦ No dependency changes detected"
        fi